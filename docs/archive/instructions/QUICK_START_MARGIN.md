# 快速开始 - 新保证金计算系统

## 🎯 一句话总结

**现在系统会在下单前精确计算保证金需求（包含手续费和安全缓冲），自动调整订单大小，避免51008错误（保证金不足）。**

---

## 🚀 你只需要知道这些

### 1. AI决策格式不变
AI仍然按照原来的格式返回决策：
```json
{
  "symbol": "XRP",
  "action": "OPEN_LONG",
  "size_usdt": 500,        // AI给出期望金额
  "leverage": 5,           // AI给出杠杆
  "take_profit": 2.58,
  "stop_loss": 2.48
}
```

### 2. 系统自动处理一切

**场景A: 资金充足**
```
可用资金: 600 USDT
请求金额: 500 USDT
结果: ✅ 直接执行，使用约527 USDT（含手续费和缓冲）
```

**场景B: 资金略少**
```
可用资金: 300 USDT
请求金额: 500 USDT
结果: ✅ 自动调整为280 USDT订单，执行成功
```

**场景C: 资金太少**
```
可用资金: 10 USDT
请求金额: 500 USDT
结果: ❌ 拒绝订单，提示"资金不足，需要至少XX USDT"
```

### 3. 日志示例

当订单执行时，你会看到详细的日志：
```
[execute-decision] ========== 保证金计算开始 ==========
币种: XRP, 价格: 2.5306, 杠杆: 5x
请求金额: $500.00, 可用资金: $300.00

【保证金计算结果】
币种: XRP
合约张数: 987 张
名义价值: $2497.70
所需保证金: $499.54
总手续费: $2.4978
建议准备: $527.14 USDT

⚠️ 资金不足，尝试自动调整订单大小...
✅ 订单已自动调整为 $280.00 USDT
[execute-decision] ========== 保证金计算结束 ==========
```

---

## 🔥 关键改进

| 功能 | 说明 |
|-----|------|
| **精确计算** | 保证金 + 开仓费 + 平仓费 + 5%缓冲 |
| **自动调整** | 资金不足时自动缩小订单 |
| **详细日志** | 每一步都有清晰的说明 |
| **友好错误** | 告诉你缺多少钱，怎么解决 |

---

## 📋 计算公式（了解即可）

对于 **XRP 5x杠杆 500 USDT** 的例子：

```
1. 合约张数 = floor((500 × 5) / 2.5306) = 987 张
2. 名义价值 = 987 × 2.5306 = 2497.70 USDT
3. 保证金 = 2497.70 / 5 = 499.54 USDT
4. 手续费 = 2497.70 × 0.001 = 2.50 USDT
5. 总需求 = 499.54 + 2.50 = 502.04 USDT
6. 建议准备 = 502.04 × 1.05 = 527.14 USDT
```

**结论**: 500 USDT 不够，至少需要 502 USDT，建议 527 USDT

---

## ⚡ 常见问题

### Q1: 为什么500 USDT请求会被调整为280 USDT？
**A**: 因为你的账户只有300 USDT可用。系统计算后发现280 USDT订单需要约295 USDT（含手续费和缓冲），刚好够用。

### Q2: 手续费怎么算的？
**A**: OKX taker费率0.05%，开仓+平仓=0.1%。例如2500 USDT名义价值，手续费=2.5 USDT。

### Q3: 5%安全缓冲是什么？
**A**: 价格可能小幅波动（如2-3%），预留缓冲避免临界状态下的保证金不足。

### Q4: 如果我就是想用全部资金怎么办？
**A**: 系统会自动最大化利用。如果你有100 USDT，会尝试调整订单使用约95 USDT（留5 USDT缓冲）。

### Q5: 什么情况会下单失败？
**A**: 
- 可用资金连1张合约都买不起
- 币种价格太高（如BTC需要1万+USDT）
- API错误或网络问题

---

## 🎨 前端显示

成功执行后，返回数据包含 `marginInfo`：
```json
{
  "success": true,
  "marginInfo": {
    "contractSize": 555,              // 实际下单张数
    "notionalValue": "1404.48",       // 合约总价值
    "requiredMargin": "280.90",       // 保证金
    "fees": "2.8090",                 // 手续费
    "totalUsed": "297.94",            // 总共使用的资金
    "leverage": 5                     // 杠杆倍数
  }
}
```

可以在前端展示给用户：
```
✅ 订单成功
合约: 555 张 XRP-USDT-SWAP
保证金: $280.90 USDT (5x杠杆)
手续费: $2.81 USDT
总投入: $297.94 USDT
```

---

## 🔧 调试技巧

### 如果下单还是失败
1. **查看日志**: 搜索 `[execute-decision]`
2. **检查 marginInfo**: 看看系统计算出多少
3. **对比可用资金**: `/api/equity` 查看账户余额
4. **查看错误码**: OKX返回的具体错误

### 日志位置
- 开发环境: 终端输出
- 生产环境: Next.js日志文件

---

## 📚 更多文档

- **详细原理**: `MARGIN_CALCULATION.md`
- **更新日志**: `CHANGELOG_MARGIN_FIX.md`
- **代码位置**: `src/lib/margin-calculator.ts`

---

## ✨ 最后

这个修复确保了：
- ✅ **不会再看到51008错误**（保证金不足）
- ✅ **AI给什么参数都能正确处理**
- ✅ **资金不足时自动优化**
- ✅ **日志清晰，问题好排查**

放心使用吧！🚀

